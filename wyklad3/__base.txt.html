
Zajęcia II
Opis zadania
Zadanie polega na stworzeniu zadanego schematu bazy danych. 
Schemat do uwtworzenia
Wysłanie zadania
Za każdym razem wysyłacie Państwo pełny skrypt tworzący schemat
od zera. Po wykonaniu testów baza danych, na której
Wasz schemat został stworzony jest niszczona.
Zadania są podzielone na fragmenty, by uprościć Państwu pracę i
sprawdzanie.
Polecenie jest podobne do:
,/bd_run_tests.py --user_id id --unit_no 3 --task_no 6 check --file script=[sciezka do pliku ze schematem]
Na przykład:
./bd_run_tests.py --user_id 0000 --unit_no 3 --task_no 5 check --file script=/home/jb/programs/bazy_danych_checker/units/unit3/model_schema.sql
Zadanie 1; Tabela status
Tabela status ma dwie kolumny: key oraz label
Kolumna key jest kluczem głównym.
Nazwa tabeli TAG
W podanej tabeli proszę umieścić takie wiersze (tj. dodać wyrażenie
INSERT w skrypcue).
key label
'status:student', Student
'status:doktorant', Doktorant
'status:absolwent', Absolwent
'praca:inz', Praca Inżynierska
'praca:mgr', Praca Magisterska
'praca:dr', Praca Doktorska
Zadanie 2: Podstawowy schemat tabeli student
Proszę utworzyć podstawowy schemat tabeli student, czyli:
Nazwa tabeli STUDENT
id, które ma wartość ustalaną automatycznie i jest kluczem głównym
name, surname, message, status kolumny typu character varying.
gender kolumna typu integer
Zadanie 3: Dodanie constraintów do tabeli student
name, surname, message nie może być nullem
gender ma wartość 0 lub 1
status jest kluczem obcym to tabeli TAG
Zadanie 4: Tabela pracownik, podstawowy schemat
Proszę utworzyć podstawowy schemat tabeli PRACOWNIK, czyli:
Nazwa tabeli PRACOWNIK
id które ma wartość ustalaną automatycznie i jest kluczem głównym
name, surname, tel_no kolumny typu character varying.
gender kolumna typu integer
Zadanie 5: Tabela pracownik, dodatkowe ograniczenia
Proszę dodać ograniczenia do tabeli pracownik:
name, surname, tel_no nie może być nullem
gender ma wartość 0 lub 1
tel_no jest ładnie sformatowanym numerem na Wydział
Fizyki: tj. 22 234-xx-xx gdzie x to liczba od 0 do 9. Polecam
klauzulę 
SIMILAR TO
, ale podejrzemwam że można ten sam efekt osiągnąć za pomocą
kilku ograniczeń
Zadanie 6: Tabela praca dyplomowa
Tabela ta ma złożony klucz główny, możemy tak zrobić, bowiem pracę
dyplomową jednoznacznie identyfikuje id studenta oraz
jej typ typ. jeden student może napisać jedną pracę
inżynierską.
Podstawowe dane tabeli:
student_id Klucz obcy do tabeli student, element klucza głównego
type Klucz obcy to tabeli tag, element klucza głównego
promotor_id klucz obcy to tabeli pracownik
tytuł ciąg znaków
Zadanie 7
Dodanie warunków kaskadowania do tabeli PRACA_DYPLOMOWA,
W momencie usunięcia studenta usuwane są wszystkie prace dyplomowe
W momencie usunięcia pracownika prace dyplomowe, które promował
przestają mieć przypisanego promotora.
Zadanie 8
Tak skonfigurować klucze obce do tabeli TAG, by
usunięcie wierszy z tej tabeli było niemożliwe, jeśli
do wspomnianych wierszy odnoszą się inne tabele.
Zadanie 9 
To zadanie uruchamia wszystkie poprzednie testy, nie trzeba
nic do niego dopisywać.
Jak czytać wyniki testów?
Przykład: 
test_create_prace_dyplomowe (units.unit3.task7.TestSuite) ... ERROR
test_praca_dyplomowa_cascades_student (units.unit3.task7.TestSuite) ... ERROR
test_praca_dyplomowa_pracownik_fk (units.unit3.task7.TestSuite) ... FAIL
test_praca_dyplomowa_student_fk (units.unit3.task7.TestSuite) ... FAIL
======================================================================
ERROR: test_create_prace_dyplomowe (units.unit3.task7.TestSuite)
----------------------------------------------------------------------
Traceback (most recent call last):
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 871, in _execute_context
context)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/default.py", line 322, in do_execute
cursor.execute(statement, parameters)
psycopg2.IntegrityError: insert or update on table "PRACA_DYPLOMOWA" violates foreign key constraint "PRACA_DYPLOMOWA_promotor_id_fkey"
DETAIL:  Key (promotor_id)=(7) is not present in table "PRACOWNIK".
The above exception was the direct cause of the following exception:
Traceback (most recent call last):
File "/home/jb/programs/bazy_danych_checker/units/unit3/task7.py", line 36, in test_create_prace_dyplomowe
self.session.flush()
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/session.py", line 1788, in flush
self._flush(objects)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/session.py", line 1870, in _flush
flush_context.execute()
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/unitofwork.py", line 372, in execute
rec.execute(self)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/unitofwork.py", line 525, in execute
uow
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/persistence.py", line 63, in save_obj
table, insert)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/persistence.py", line 537, in _emit_insert_statements
execute(statement, multiparams)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 664, in execute
params)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 764, in _execute_clauseelement
compiled_sql, distilled_params
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 878, in _execute_context
context)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 1036, in _handle_dbapi_exception
from e
sqlalchemy.exc.IntegrityError: (IntegrityError) insert or update on table "PRACA_DYPLOMOWA" violates foreign key constraint "PRACA_DYPLOMOWA_promotor_id_fkey"
DETAIL:  Key (promotor_id)=(7) is not present in table "PRACOWNIK".
'INSERT INTO "PRACA_DYPLOMOWA" (tytul, type, student_id, promotor_id) VALUES (%(tytul)s, %(type)s, %(student_id)s, %(promotor_id)s)' {'student_id': 4, 'type': 'praca:dr', 'tytul': 'foo bar', 'promotor_id': 7}
======================================================================
ERROR: test_praca_dyplomowa_cascades_student (units.unit3.task7.TestSuite)
----------------------------------------------------------------------
Traceback (most recent call last):
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 871, in _execute_context
context)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/default.py", line 322, in do_execute
cursor.execute(statement, parameters)
psycopg2.IntegrityError: update or delete on table "STUDENT" violates foreign key constraint "PRACA_DYPLOMOWA_student_id_fkey" on table "PRACA_DYPLOMOWA"
DETAIL:  Key (id)=(9) is still referenced from table "PRACA_DYPLOMOWA".
The above exception was the direct cause of the following exception:
Traceback (most recent call last):
File "/home/jb/programs/bazy_danych_checker/units/unit3/task7.py", line 75, in test_praca_dyplomowa_cascades_student
self.session.flush()
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/session.py", line 1788, in flush
self._flush(objects)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/session.py", line 1870, in _flush
flush_context.execute()
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/unitofwork.py", line 372, in execute
rec.execute(self)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/unitofwork.py", line 553, in execute
uow
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/persistence.py", line 115, in delete_obj
cached_connections, mapper, table, delete)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/persistence.py", line 677, in _emit_delete_statements
connection.execute(statement, del_objects)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 664, in execute
params)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 764, in _execute_clauseelement
compiled_sql, distilled_params
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 878, in _execute_context
context)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 1036, in _handle_dbapi_exception
from e
sqlalchemy.exc.IntegrityError: (IntegrityError) update or delete on table "STUDENT" violates foreign key constraint "PRACA_DYPLOMOWA_student_id_fkey" on table "PRACA_DYPLOMOWA"
DETAIL:  Key (id)=(9) is still referenced from table "PRACA_DYPLOMOWA".
'DELETE FROM "STUDENT" WHERE "STUDENT".id = %(id)s' {'id': 9}
======================================================================
FAIL: test_praca_dyplomowa_pracownik_fk (units.unit3.task7.TestSuite)
----------------------------------------------------------------------
Traceback (most recent call last):
File "/home/jb/programs/bazy_danych_checker/units/unit3/task7.py", line 60, in test_praca_dyplomowa_pracownik_fk
self.assertRaises(IntegrityError, fun)
AssertionError: IntegrityError not raised by fun
======================================================================
FAIL: test_praca_dyplomowa_student_fk (units.unit3.task7.TestSuite)
----------------------------------------------------------------------
Traceback (most recent call last):
File "/home/jb/programs/bazy_danych_checker/units/unit3/task7.py", line 48, in test_praca_dyplomowa_student_fk
self.assertRaises(IntegrityError, fun)
AssertionError: IntegrityError not raised by fun
----------------------------------------------------------------------
Ran 4 tests in 1.124s
FAILED (failures=2, errors=2)
==============================
captured stdout
==============================
select version()
{}
select current_schema()
{}
BEGIN (implicit)
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Chryzostan', 'surname': 'Seibel', 'gender': 1, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Ismail', 'surname': 'Węgrzyn', 'gender': 0, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Abdon', 'surname': 'Lewicki', 'gender': 0, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Nasiadko', 'surname': 'Wójtowicz', 'gender': 1, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Dębowska', 'surname': 'Kosiński', 'gender': 0, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Broszko', 'surname': 'Łabęda', 'gender': 0, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Szenkman', 'surname': 'Pawelec', 'gender': 0, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Rodz', 'surname': 'Olkusz', 'gender': 0, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "PRACA_DYPLOMOWA" (tytul, type, student_id, promotor_id) VALUES (%(tytul)s, %(type)s, %(student_id)s, %(promotor_id)s)
{'student_id': 4, 'type': 'praca:dr', 'tytul': 'foo bar', 'promotor_id': 7}
ROLLBACK
BEGIN (implicit)
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Jeź', 'surname': 'Rumiński', 'gender': 0, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "PRACOWNIK" (name, surname, gender, tel_no) VALUES (%(name)s, %(surname)s, %(gender)s, %(tel_no)s) RETURNING "PRACOWNIK".id
{'tel_no': '22 234-89-59', 'name': 'Schleif', 'gender': 1, 'surname': 'Jankowski'}
INSERT INTO "PRACA_DYPLOMOWA" (tytul, type, student_id, promotor_id) VALUES (%(tytul)s, %(type)s, %(student_id)s, %(promotor_id)s)
{'student_id': 9, 'type': 'praca:dr', 'tytul': 'foo bar', 'promotor_id': 1}
INSERT INTO "PRACA_DYPLOMOWA" (tytul, type, student_id, promotor_id) VALUES (%(tytul)s, %(type)s, %(student_id)s, %(promotor_id)s)
{'student_id': 9, 'type': 'praca:inz', 'tytul': 'foo bar', 'promotor_id': 1}
INSERT INTO "PRACA_DYPLOMOWA" (tytul, type, student_id, promotor_id) VALUES (%(tytul)s, %(type)s, %(student_id)s, %(promotor_id)s)
{'student_id': 9, 'type': 'praca:mgr', 'tytul': 'foo bar', 'promotor_id': 1}
DELETE FROM "STUDENT" WHERE "STUDENT".id = %(id)s
{'id': 9}
ROLLBACK
BEGIN (implicit)
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Nieprasz', 'surname': 'Rogalińska', 'gender': 1, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
INSERT INTO "PRACOWNIK" (name, surname, gender, tel_no) VALUES (%(name)s, %(surname)s, %(gender)s, %(tel_no)s) RETURNING "PRACOWNIK".id
{'tel_no': '22 234-24-59', 'name': 'Yoshiko', 'gender': 0, 'surname': 'Nodzak'}
ROLLBACK
BEGIN (implicit)
INSERT INTO "PRACOWNIK" (name, surname, gender, tel_no) VALUES (%(name)s, %(surname)s, %(gender)s, %(tel_no)s) RETURNING "PRACOWNIK".id
{'tel_no': '22 234-81-87', 'name': 'Szałecki', 'gender': 1, 'surname': 'Jung'}
INSERT INTO "STUDENT" (name, surname, gender, status, message) VALUES (%(name)s, %(surname)s, %(gender)s, %(status)s, %(message)s) RETURNING "STUDENT".id
{'name': 'Krupińska', 'surname': 'Mańkowski', 'gender': 1, 'message': 'Fizyka jest super', 'status': 'status:absolwent'}
ROLLBACK
==============================
end captured stdout
==============================
Zadanie nie zaliczone
Oceniono 0000 i None
Pierwszą sekcją jes lista testów i ich wyników. Wyniki FAIL i ERROR
oznaczają że dany test nie wykonał się poprawnie.
test_create_prace_dyplomowe (units.unit3.task7.TestSuite) ... ERROR
test_praca_dyplomowa_cascades_student (units.unit3.task7.TestSuite) ... ERROR
test_praca_dyplomowa_pracownik_fk (units.unit3.task7.TestSuite) ... FAIL
test_praca_dyplomowa_student_fk (units.unit3.task7.TestSuite) ... FAIL
Dalej mamy informacje o wynikach testów które się nie powiodły
======================================================================
ERROR: test_praca_dyplomowa_cascades_student (units.unit3.task7.TestSuite)
----------------------------------------------------------------------
Traceback (most recent call last):
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 871, in _execute_context
context)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/default.py", line 322, in do_execute
cursor.execute(statement, parameters)
psycopg2.IntegrityError: update or delete on table "STUDENT" violates foreign key constraint "PRACA_DYPLOMOWA_student_id_fkey" on table "PRACA_DYPLOMOWA"
DETAIL:  Key (id)=(9) is still referenced from table "PRACA_DYPLOMOWA".
The above exception was the direct cause of the following exception:
Traceback (most recent call last):
File "/home/jb/programs/bazy_danych_checker/units/unit3/task7.py", line 75, in test_praca_dyplomowa_cascades_student
self.session.flush()
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/session.py", line 1788, in flush
self._flush(objects)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/session.py", line 1870, in _flush
flush_context.execute()
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/unitofwork.py", line 372, in execute
rec.execute(self)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/unitofwork.py", line 553, in execute
uow
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/persistence.py", line 115, in delete_obj
cached_connections, mapper, table, delete)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/orm/persistence.py", line 677, in _emit_delete_statements
connection.execute(statement, del_objects)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 664, in execute
params)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 764, in _execute_clauseelement
compiled_sql, distilled_params
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 878, in _execute_context
context)
File "/home/jb/.pythonbrew/venvs/Python-3.3.0/bazydanych/lib/python3.3/site-packages/sqlalchemy/engine/base.py", line 1036, in _handle_dbapi_exception
from e
sqlalchemy.exc.IntegrityError: (IntegrityError) update or delete on table "STUDENT" violates foreign key constraint "PRACA_DYPLOMOWA_student_id_fkey" on table "PRACA_DYPLOMOWA"
DETAIL:  Key (id)=(9) is still referenced from table "PRACA_DYPLOMOWA".
'DELETE FROM "STUDENT" WHERE "STUDENT".id = %(id)s' {'id': 9}
Tutaj ważne są informacje: "update or delete on table "STUDENT" violates foreign key constraint "PRACA_DYPLOMOWA_student_id_fkey" on table "PRACA_DYPLOMOWA"
DETAIL:  Key (id)=(9) is still referenced from table "PRACA_DYPLOMOWA"."
ta informacja pewnie znaczy, że test próbował usunąć element z tabeli student
co mu się nie udało.
Wreszcie na końcu mamy SQL generowane przez kod testowy, niestety
nie udało mi się łatwo generować kodu "do wstawienia", więc raczej
ma on dawać ogólne pojęcie o wykonywanych komendach.
Strona ta stosuje pliki cookies generowane przez system gogole analytics.
Można sobie je wyłączyć do jej prawidłowego działania.
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-39180012-1']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
